<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
  <title>Enter the Y2K Quantum Vault</title>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@500;700&display=swap" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Space Grotesk', sans-serif; }
    body {
      background-color: #000;
      color: #fff;
      padding: env(safe-area-inset);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
    }
    .vault-box {
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 18px;
      padding: 24px;
      width: 92%;
      max-width: 400px;
      text-align: center;
      backdrop-filter: blur(16px);
      box-shadow: 0 0 20px rgba(0,255,225,0.08);
    }
    .vault-box h1 {
      font-size: 22px;
      margin-bottom: 14px;
      color: #00ffe1;
    }
    .vault-box p {
      font-size: 13px;
      color: #bbb;
      margin-bottom: 12px;
    }
    input, textarea {
      width: 100%;
      padding: 10px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.1);
      background: #111;
      color: #00ffe1;
      margin-bottom: 14px;
      font-size: 13px;
    }
    .connect-btn, .proceed-btn, .sign-btn {
      width: 100%;
      padding: 12px;
      background: linear-gradient(135deg, #6366f1, #8b5cf6);
      color: #fff;
      font-weight: bold;
      font-size: 14px;
      border: none;
      border-radius: 10px;
      margin-top: 10px;
      cursor: pointer;
      transition: 0.2s ease;
    }
    .connect-btn:hover, .proceed-btn:hover {
      transform: scale(1.02);
    }
    .pfp-preview {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid #00ffe1;
      margin: 10px auto;
    }
    .hidden { display: none; }
    label.upload-btn {
      background: #222;
      border: 1px solid #00ffe140;
      color: #00ffe1;
      padding: 6px 12px;
      border-radius: 8px;
      font-size: 12px;
      cursor: pointer;
      display: inline-block;
      margin-bottom: 10px;
    }
  </style>
</head>
<body>
  <div class="vault-box">
    <h1>Enter the Quantum Vault</h1>
    <p>Please connect your wallet and accept the disclaimer to continue.</p>
    <button id="connectWalletBtn" class="connect-btn">Connect Wallet</button>
    <p id="walletDisplay" style="font-size:13px; margin-top:10px;"></p>
    <p id="balanceDisplay" style="font-size:13px; color:#00ffe1;"></p>

    <p style="margin-top:16px;">Disclaimer: This is a gambling application. Loss of funds is possible. DYOR.</p>
    <button id="signDisclaimerBtn" class="sign-btn hidden">Accept & Sign to Continue</button>

    <div id="profileFields" class="hidden">
      <input id="username" type="text" placeholder="Pick a username (required)" />
      <input id="xhandle" type="text" placeholder="𝕏 handle (optional)" />
      <img id="pfpPreview" class="pfp-preview hidden" src="" alt="PFP" />
      <label class="upload-btn" for="pfpInput">Choose Profile Picture</label>
      <input id="pfpInput" type="file" accept="image/*" class="hidden" />
      <button id="proceedBtn" class="proceed-btn">Create Profile & Enter</button>
    </div>
  </div>

  <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
  import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";
  import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-storage.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCJwqDFZtf1PkZwAalOaf2_7eWtej5HIfA",
    authDomain: "y2k-arcade.firebaseapp.com",
    projectId: "y2k-arcade",
    storageBucket: "y2k-arcade.appspot.com",
    messagingSenderId: "1063043176357",
    appId: "1:1063043176357:web:20bc22e9cbf269ff40fa4c"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const storage = getStorage(app);

  const contractAddress = "0xB4Df7d2A736Cc391146bB0dF4277E8F68247Ac6d";
  const cronosRpc = "https://evm.cronos.org";
  const provider = new ethers.providers.JsonRpcProvider(cronosRpc);
  let currentWallet = "";
  let selectedPFP = null;

  const connectBtn = document.getElementById("connectWalletBtn");
  const signBtn = document.getElementById("signDisclaimerBtn");
  const profileFields = document.getElementById("profileFields");
  const proceedBtn = document.getElementById("proceedBtn");
  const pfpInput = document.getElementById("pfpInput");
  const pfpPreview = document.getElementById("pfpPreview");

  connectBtn.onclick = async () => {
    try {
      const accounts = await window.ethereum.request({ method: "eth_requestAccounts" });
      currentWallet = accounts[0].toLowerCase();
      document.getElementById("walletDisplay").textContent = `Connected: ${currentWallet.slice(0,6)}...${currentWallet.slice(-4)}`;
      await fetchBalance(currentWallet);
      signBtn.classList.remove("hidden");
    } catch (err) {
      console.error("Wallet connection failed", err);
    }
  };

  async function fetchBalance(wallet) {
    const abi = ["function balanceOf(address) view returns (uint256)"];
    const token = new ethers.Contract(contractAddress, abi, provider);
    try {
      const balance = await token.balanceOf(wallet);
      const y2k = parseFloat(ethers.utils.formatUnits(balance, 18)).toFixed(2);
      document.getElementById("balanceDisplay").textContent = `Balance: ${y2k} Y2K`;
    } catch (e) {
      console.warn("Balance fetch failed:", e);
    }
  }

  signBtn.onclick = async () => {
    try {
      const message = "By signing this message, I accept the risks of using the Y2K Quantum Vault. DYOR.";
      const signed = await window.ethereum.request({
        method: "personal_sign",
        params: [message, currentWallet]
      });
      console.log("Signature confirmed:", signed);
      signBtn.classList.add("hidden");
      profileFields.classList.remove("hidden");
    } catch (err) {
      console.error("Signature rejected:", err);
    }
  };

  pfpInput.addEventListener("change", (e) => {
    selectedPFP = e.target.files[0];
    if (selectedPFP) {
      const reader = new FileReader();
      reader.onload = () => {
        pfpPreview.src = reader.result;
        pfpPreview.classList.remove("hidden");
      };
      reader.readAsDataURL(selectedPFP);
    }
  });

  proceedBtn.onclick = async () => {
    const username = document.getElementById("username").value.trim();
    const xhandle = document.getElementById("xhandle").value.trim();

    if (!username || !currentWallet) {
      alert("Please enter a username and connect wallet.");
      return;
    }

    let pfpUrl = "";
    if (selectedPFP) {
      try {
        const storageRef = ref(storage, `pfps/${currentWallet}`);
        await uploadBytes(storageRef, selectedPFP);
        pfpUrl = await getDownloadURL(storageRef);
      } catch (err) {
        console.error("PFP upload failed:", err);
      }
    }

    const profileData = {
      username,
      xhandle: xhandle || "",
      pfpUrl,
      created: Date.now()
    };

    try {
      await setDoc(doc(db, "users", currentWallet), profileData, { merge: true });
      window.location.href = "vault.html";
    } catch (err) {
      console.error("Profile creation failed:", err);
    }
  };
</script>
    </script>
</body>
</html>
